name: æ¯æ—¥å¥åº·çœ‹æ¿è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # UTC 3:00 = åŒ—äº¬æ—¶é—´ 11:00 (æ¯å¤©11ç‚¹)
    - cron: '0 3 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'è§¦å‘åŸå› '
        required: false
        type: string

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest

    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install pandas requests openpyxl

    - name: ğŸ” è®¾ç½®Ourating API Token
      env:
        OURA_ACCESS_TOKEN: ${{ secrets.OURA_ACCESS_TOKEN }}
      run: |
        echo "API Tokenå·²è®¾ç½®ï¼ˆéšè—ï¼‰"

    - name: ğŸƒ è¿è¡Œå¥åº·çœ‹æ¿ç”Ÿæˆè„šæœ¬
      env:
        OURA_ACCESS_TOKEN: ${{ secrets.OURA_ACCESS_TOKEN }}
      run: |
        echo "å¼€å§‹è¿è¡Œå¥åº·çœ‹æ¿ç”Ÿæˆ..."
        python3 ultimate_dashboard.py

        if [ $? -eq 0 ]; then
          echo "âœ… å¥åº·çœ‹æ¿ç”ŸæˆæˆåŠŸ"

          # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“Š ä»Šæ—¥ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -lh DailyReports/*.html 2>/dev/null || echo "  æ— HTMLæ–‡ä»¶"
          ls -lh DailyReports/*.md 2>/dev/null || echo "  æ— Markdownæ–‡ä»¶"

          # æ£€æŸ¥å›¾è¡¨
          if [ -d "DailyReports/charts" ]; then
            echo "ğŸ“ˆ å›¾è¡¨æ–‡ä»¶ï¼š"
            ls -lh DailyReports/charts/*.png 2>/dev/null | wc -l || echo "  å›¾è¡¨ç¼ºå¤±"
          fi
        else
          echo "âŒ å¥åº·çœ‹æ¿ç”Ÿæˆå¤±è´¥"
          exit 1
        fi

    - name: ğŸ“Š æ˜¾ç¤ºç”Ÿæˆç»Ÿè®¡
      run: |
        echo "ğŸ“Š ç”Ÿæˆç»Ÿè®¡ï¼š"
        echo "HTMLæ–‡ä»¶æ•°ï¼š$(ls DailyReports/*.html 2>/dev/null | wc -l)"
        echo "å›¾è¡¨æ–‡ä»¶æ•°ï¼š$(ls DailyReports/charts/*.png 2>/dev/null | wc -l)"
        echo "Markdownæ–‡ä»¶æ•°ï¼š$(ls DailyReports/*.md 2>/dev/null | wc -l)"

    - name: ğŸ’¾ æäº¤å˜æ›´åˆ°ä»“åº“
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions Bot"

        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add .

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "âœ… æ²¡æœ‰æ–°å˜æ›´éœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ¨é€: æ¯æ—¥å¥åº·çœ‹æ¿æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S') [è‡ªåŠ¨]"

          echo "ğŸ“ æäº¤ä¿¡æ¯ï¼š"
          git log -1 --oneline
        fi

    - name: ğŸš€ æ¨é€åˆ°GitHub
      run: |
        git push
        echo "âœ… ä»£ç å·²æ¨é€åˆ°mainåˆ†æ”¯"

    - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: success()
        run: |
          echo "âœ… å¥åº·çœ‹æ¿å·²æˆåŠŸæ›´æ–°å¹¶éƒ¨ç½²ï¼"
          echo "ğŸŒ ç½‘ç«™åœ°å€ï¼šhttps://williamjoy-health.netlify.app"
      else
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

    - name: ğŸ”” å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: success()
        run: |
          echo "ğŸ’¡ å¯é€‰ï¼šé…ç½®Slack/Emailé€šçŸ¥"
          echo "   æ¨é€å†…å®¹ï¼šå¥åº·çœ‹æ¿å·²æ›´æ–°"
