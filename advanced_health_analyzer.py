#!/usr/bin/env python3
"""
é‡‘æ˜ - é«˜çº§å¥åº·æ•°æ®åˆ†ææ¨¡å—
æä¾›æ›´æ·±å…¥çš„æ•°æ®åˆ†æå’Œå»ºè®®
"""

class AdvancedHealthAnalyzer:
    """é«˜çº§å¥åº·æ•°æ®åˆ†æå™¨"""

    def __init__(self):
        self.hrv_zones = {
            "very_high": {"range": "â‰¥80", "meaning": "æä½³æ¢å¤çŠ¶æ€ï¼Œé€‚åˆé«˜å¼ºåº¦è®­ç»ƒ", "color": "ğŸŸ¢"},
            "high": {"range": "65-79", "meaning": "è‰¯å¥½æ¢å¤çŠ¶æ€ï¼Œé€‚åˆä¸­ç­‰å¼ºåº¦è®­ç»ƒ", "color": "ğŸŸ¢"},
            "moderate": {"range": "50-64", "meaning": "ä¸­ç­‰æ¢å¤çŠ¶æ€ï¼Œé€‚åˆç»´æŒè®­ç»ƒ", "color": "ğŸŸ¡"},
            "low": {"range": "35-49", "meaning": "æ¢å¤ä¸è¶³ï¼Œå»ºè®®ä¼‘æ¯", "color": "ğŸŸ "},
            "very_low": {"range": "<35", "meaning": "ä¸¥é‡ç–²åŠ³ï¼Œå¿…é¡»ä¼‘æ¯", "color": "ğŸ”´"}
        }

        self.rhr_zones = {
            "elite": {"range": "40-50", "meaning": "ç²¾è‹±è¿åŠ¨å‘˜æ°´å¹³", "color": "â­"},
            "excellent": {"range": "51-55", "meaning": "ä¼˜ç§€æ°´å¹³", "color": "ğŸ’š"},
            "good": {"range": "56-60", "meaning": "è‰¯å¥½æ°´å¹³", "color": "ğŸ’š"},
            "average": {"range": "61-70", "meaning": "ä¸€èˆ¬æ°´å¹³", "color": "ğŸŸ¡"},
            "poor": {"range": ">70", "meaning": "éœ€æ”¹å–„", "color": "ğŸ”´"}
        }

    def analyze_hrv_in_depth(self, hrv_score):
        """æ·±åº¦åˆ†æHRV"""
        hrv_value = hrv_score

        # åˆ¤æ–­åŒºé—´
        if hrv_value >= 80:
            zone = self.hrv_zones["very_high"]
        elif hrv_value >= 65:
            zone = self.hrv_zones["high"]
        elif hrv_value >= 50:
            zone = self.hrv_zones["moderate"]
        elif hrv_value >= 35:
            zone = self.hrv_zones["low"]
        else:
            zone = self.hrv_zones["very_low"]

        return {
            "current_value": hrv_value,
            "zone": zone,
            "trend": self._get_hrv_trend(hrv_value),
            "recommendations": self._get_hrv_recommendations(hrv_value)
        }

    def _get_hrv_trend(self, current_hrv):
        """è·å–HRVè¶‹åŠ¿å»ºè®®"""
        if current_hrv >= 80:
            return "ğŸ“ˆ è¶‹åŠ¿ï¼šæé«˜HRVï¼Œèº«ä½“å¤„äºæä½³æ¢å¤çŠ¶æ€"
        elif current_hrv >= 65:
            return "ğŸ“Š è¶‹åŠ¿ï¼šé«˜HRVï¼Œæ¢å¤è‰¯å¥½"
        elif current_hrv >= 50:
            return "â¡ï¸ è¶‹åŠ¿ï¼šä¸­ç­‰HRVï¼Œç»´æŒå½“å‰è®­ç»ƒå¼ºåº¦"
        elif current_hrv >= 35:
            return "ğŸ“‰ è¶‹åŠ¿ï¼šä½HRVï¼Œè€ƒè™‘å‡å°‘è®­ç»ƒå¼ºåº¦"
        else:
            return "â¬‡ï¸ è¶‹åŠ¿ï¼šæä½HRVï¼Œå¿…é¡»ä¼‘æ¯æ¢å¤"

    def _get_hrv_recommendations(self, hrv_value):
        """åŸºäºHRVçš„å»ºè®®"""
        if hrv_value >= 80:
            return [
                "âœ“ é€‚åˆè¿›è¡Œæé™è®­ç»ƒæˆ–æŒ‘æˆ˜PB",
                "âœ“ èº«ä½“å®Œå…¨æ¢å¤ï¼Œå¯ä»¥è¿›è¡Œé«˜å¼ºåº¦é—´æ­‡è®­ç»ƒ",
                "âœ“ å¯ä»¥å°è¯•æ–°çš„æŠ€æœ¯æˆ–è®­ç»ƒæ–¹æ³•",
                "ğŸ’¡ å»ºè®®ï¼šåˆ©ç”¨è¿™ä¸ªæœ€ä½³çŠ¶æ€ï¼Œçªç ´ä¸ªäººè®°å½•"
            ]
        elif hrv_value >= 65:
            return [
                "âœ“ é€‚åˆç³»ç»Ÿè®­ç»ƒ",
                "âœ“ å¯ä»¥å¢åŠ è®­ç»ƒé‡10-15%",
                "âœ“ æŠ€æœ¯è®­ç»ƒçš„å¥½æ—¶æœº",
                "ğŸ’¡ å»ºè®®ï¼šä¸“æ³¨äºæŠ€æœ¯ç»†èŠ‚å’ŒåŠ›é‡è®­ç»ƒ"
            ]
        elif hrv_value >= 50:
            return [
                "âš ï¸ ç»´æŒå½“å‰è®­ç»ƒå¼ºåº¦",
                "âš ï¸ é¿å…çªç„¶å¢åŠ è®­ç»ƒé‡",
                "âš ï¸ é‡è§†æ¢å¤å’Œè¥å…»",
                "ğŸ’¡ å»ºè®®ï¼šä¿æŒç¨³å®šï¼Œä¸è¦æ€¥äºæ±‚æˆ"
            ]
        else:
            return [
                "âŒ å‡å°‘è®­ç»ƒå¼ºåº¦50%",
                "âŒ åªè¿›è¡Œè½»åº¦æ´»åŠ¨ï¼ˆæ•£æ­¥ã€ç‘œä¼½ã€æ‹‰ä¼¸ï¼‰",
                "âŒ å¢åŠ ç¡çœ æ—¶é—´",
                "âŒ è¡¥å……æŠ—æ°§åŒ–å‰‚å’Œæ¢å¤è¥å…»",
                "ğŸ’¡ å»ºè®®ï¼šä¼‘æ¯æ˜¯ä¸ºäº†æ›´å¥½çš„è®­ç»ƒï¼Œä»Šå¤©å¥½å¥½æ¢å¤"
            ]

    def generate_advanced_health_metrics_md(self, health_data):
        """ç”Ÿæˆé«˜çº§å¥åº·æŒ‡æ ‡Markdown"""

        readiness = health_data.get("readiness", {})
        contributors = readiness.get("contributors", {})

        hrv_score = contributors.get("hrv_balance", 0)
        rhr_score = readiness.get("score", 0)
        recovery_score = contributors.get("recovery_index", 0)
        activity_score = contributors.get("activity_balance", 0)
        sleep_balance = contributors.get("sleep_balance", 0)

        md = """## ğŸ“ˆ é«˜çº§å¥åº·æŒ‡æ ‡åˆ†æ

### ğŸ’“ å¿ƒç‡å˜å¼‚æ€§ï¼ˆHRVï¼‰æ·±åº¦åˆ†æ

"""

        # HRVåˆ†æ
        hrv_analysis = self.analyze_hrv_in_depth(hrv_score)

        # HRVè¿›åº¦æ¡
        hrv_bar = self._create_progress_bar(hrv_score, 100)

        md += f"""**å½“å‰HRVï¼š** {hrv_score}/100

**HRVè¿›åº¦æ¡ï¼š**
{hrv_bar}

**çŠ¶æ€åŒºé—´ï¼š** {hrv_analysis['zone']['color']} {hrv_analysis['zone']['range']} - {hrv_analysis['zone']['meaning']}

**è¶‹åŠ¿åˆ†æï¼š**
{hrv_analysis['trend']}

**è¯¦ç»†å»ºè®®ï¼š**
"""
        for rec in hrv_analysis['recommendations']:
            md += f"{rec}\n"

        md += f"""
---

### ğŸƒ æ´»åŠ¨æ•°æ®åˆ†æ

**æ´»åŠ¨å¹³è¡¡ï¼š** {activity_score}/100

"""

        # æ´»åŠ¨å»ºè®®
        if activity_score >= 80:
            md += """**çŠ¶æ€ï¼š** ğŸŸ¢ ä¼˜ç§€ - æ´»åŠ¨é‡å……è¶³

**åˆ†æï¼š**
- ä»Šæ—¥æ´»åŠ¨é‡éå¸¸é«˜ï¼Œæ¥è¿‘ç†æƒ³æ°´å¹³
- æœ‰æ°§å’Œæ— æ°§è®­ç»ƒå¹³è¡¡è‰¯å¥½
- æ—¥å¸¸æ´»åŠ¨é‡å……è¶³

**å»ºè®®ï¼š**
- âœ“ ç»§ç»­ä¿æŒå½“å‰æ´»åŠ¨æ°´å¹³
- âœ“ ç¡®ä¿å……è¶³ä¼‘æ¯å’Œè¥å…»è¡¥å……
- ğŸ’¡ æé†’ï¼šé«˜å¼ºåº¦è®­ç»ƒåæ³¨æ„æ¢å¤

"""
        elif activity_score >= 60:
            md += """**çŠ¶æ€ï¼š** ğŸŸ¡ è‰¯å¥½ - æ´»åŠ¨é‡é€‚ä¸­

**åˆ†æï¼š**
- ä»Šæ—¥æ´»åŠ¨é‡é€‚ä¸­
- æœ‰æå‡ç©ºé—´

**å»ºè®®ï¼š**
- å¯ä»¥é€‚å½“å¢åŠ æ´»åŠ¨é‡
- å»ºè®®å¢åŠ 30åˆ†é’Ÿæœ‰æ°§è¿åŠ¨

"""
        else:
            md += """**çŠ¶æ€ï¼š** ğŸŸ  åä½ - æ´»åŠ¨é‡ä¸è¶³

**åˆ†æï¼š**
- ä»Šæ—¥æ´»åŠ¨é‡åä½
- å¯èƒ½å½±å“è®­ç»ƒæ•ˆæœ

**å»ºè®®ï¼š**
- å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡ï¼ˆæ­¥è¡Œã€æ¥¼æ¢¯ï¼‰
- æ·»åŠ 30åˆ†é’Ÿè½»æ¾æœ‰æ°§è¿åŠ¨
- é¿å…é•¿æ—¶é—´ä¹…å

"""

        # æ¢å¤æŒ‡æ•°æ·±åº¦åˆ†æ
        md += f"""
---

### ğŸ”„ æ¢å¤æŒ‡æ•°æ·±åº¦åˆ†æ

**æ¢å¤æŒ‡æ•°ï¼š** {recovery_score}/100

"""

        recovery_bar = self._create_progress_bar(recovery_score, 100)
        md += f"""**æ¢å¤è¿›åº¦ï¼š**
{recovery_bar}

**æ¢å¤å»ºè®®ï¼š**
"""

        if recovery_score >= 85:
            md += """- ğŸŸ¢ æ¢å¤æä½³ï¼Œèº«ä½“å®Œå…¨å‡†å¤‡å¥½è®­ç»ƒ
- âœ… å¯ä»¥è¿›è¡Œé«˜å¼ºåº¦è®­ç»ƒ
- âœ… å¯ä»¥æŒ‘æˆ˜ä¸ªäººè®°å½•
- ğŸ’¡ å»ºè®®ï¼šåˆ©ç”¨è¿™ä¸ªæœ€ä½³çŠ¶æ€ï¼Œçªç ´æé™ï¼
"""
        elif recovery_score >= 70:
            md += """- ğŸŸ¢ æ¢å¤è‰¯å¥½ï¼Œé€‚åˆç³»ç»Ÿè®­ç»ƒ
- âœ… å¯ä»¥è¿›è¡Œä¸­ç­‰å¼ºåº¦è®­ç»ƒ
- âœ… æŠ€æœ¯è®­ç»ƒçš„å¥½æ—¶æœº
- ğŸ’¡ å»ºè®®ï¼šä¸“æ³¨äºæŠ€æœ¯å’ŒåŠ›é‡æå‡
"""
        elif recovery_score >= 50:
            md += """- ğŸŸ¡ æ¢å¤ä¸€èˆ¬ï¼Œç»´æŒè®­ç»ƒå¼ºåº¦
- âš ï¸ é¿å…çªç„¶å¢åŠ è®­ç»ƒé‡
- âš ï¸ æ³¨æ„æ¢å¤å’Œè¥å…»
- ğŸ’¡ å»ºè®®ï¼šç¨³å®šè®­ç»ƒï¼Œä¸è¦æ€¥äºæ±‚æˆ
"""
        else:
            md += """- ğŸ”´ æ¢å¤ä¸è¶³ï¼Œå¿…é¡»ä¼‘æ¯ï¼
- âŒ é¿å…é«˜å¼ºåº¦è®­ç»ƒ
- âŒ åªè¿›è¡Œè½»åº¦æ´»åŠ¨
- âŒ å¢åŠ ç¡çœ æ—¶é—´
- ğŸ’¡ å»ºè®®ï¼šä¼‘æ¯æ˜¯ä¸ºäº†æ›´å¥½çš„è®­ç»ƒ
"""

        return md

    def create_progress_bars_md(self, health_data):
        """åˆ›å»ºè¿›åº¦æ¡å¯è§†åŒ–"""

        readiness = health_data.get("readiness", {})
        score = readiness.get("score", 0)
        contributors = readiness.get("contributors", {})

        md = """
### ğŸ“Š å¥åº·æŒ‡æ ‡å¯è§†åŒ–

---

#### ğŸ¯ ç»¼åˆå‡†å¤‡åº¦

**æ€»åˆ†ï¼š** """ + str(score) + """/100

"""

        md += self._create_progress_bar(score, 100, "å‡†å¤‡åº¦")

        md += f"""

**è¯„ä¼°ï¼š**
"""
        if score >= 85:
            md += "ğŸŒŸ **æä½³çŠ¶æ€** - ä»Šæ—¥æ˜¯æŒ‘æˆ˜PBçš„å¥½æ—¶æœºï¼\n"
        elif score >= 70:
            md += "âœ“ **è‰¯å¥½çŠ¶æ€** - é€‚åˆç³»ç»Ÿè®­ç»ƒ\n"
        elif score >= 55:
            md += "ğŸŸ¡ **ä¸€èˆ¬çŠ¶æ€** - ç»´æŒè®­ç»ƒå³å¯\n"
        else:
            md += "âš ï¸ **è¾ƒå·®çŠ¶æ€** - å»ºè®®ä¼‘æ¯æˆ–è½»åº¦è®­ç»ƒ\n"

        md += "\n---\n\n#### ğŸ“ˆ å„é¡¹æŒ‡æ ‡è¯¦æƒ…\n\n"

        metrics = [
            ("HRVå¹³è¡¡", contributors.get("hrv_balance", 0), "hrv"),
            ("æ¢å¤æŒ‡æ•°", contributors.get("recovery_index", 0), "recovery"),
            ("é™æ¯å¿ƒç‡", contributors.get("resting_heart_rate", 0), "rhr"),
            ("ç¡çœ å¹³è¡¡", contributors.get("sleep_balance", 0), "sleep"),
            ("æ´»åŠ¨å¹³è¡¡", contributors.get("activity_balance", 0), "activity")
        ]

        for name, value, metric_type in metrics:
            md += f"**{name}ï¼š** {value}/100\n\n"
            md += self._create_progress_bar(value, 100, name) + "\n\n"

        return md

    def _create_progress_bar(self, value, max_value, label=""):
        """åˆ›å»ºè¿›åº¦æ¡"""
        percentage = (value / max_value) * 100

        # åˆ›å»ºè¿›åº¦æ¡ï¼ˆ20æ ¼ï¼‰
        filled = int((percentage / 100) * 20)
        bar = "â–ˆ" * filled + "â–‘" * (20 - filled)

        # æ ¹æ®ç™¾åˆ†æ¯”é€‰æ‹©é¢œè‰²
        if percentage >= 80:
            color = "ğŸŸ¢"
        elif percentage >= 60:
            color = "ğŸŸ¡"
        else:
            color = "ğŸ”´"

        return f"{color} [{bar}] {percentage:.0f}%"

    def generate_data_sources_md(self):
        """ç”Ÿæˆæ•°æ®æ¥æºå’Œç§‘å­¦ä¾æ®è¯´æ˜"""

        md = """
## ğŸ“š æ•°æ®æ¥æºä¸ç§‘å­¦ä¾æ®

### ğŸ“Š æ•°æ®é‡‡é›†æ¥æº

| æ•°æ®ç±»å‹ | æ¥æº | æ›´æ–°é¢‘ç‡ | å‡†ç¡®åº¦ |
|---------|------|---------|--------|
| ç¡çœ æ•°æ® | Oura Ring Gen3 | å®æ—¶ | â­â­â­â­â­ |
| HRVæ•°æ® | Oura Ring Gen3 | å®æ—¶ | â­â­â­â­â­ |
| æ´»åŠ¨æ•°æ® | Oura Ring Gen3 | å®æ—¶ | â­â­â­â­â­ |
| å‡†å¤‡åº¦ | Oura Ringç®—æ³• | æ¯æ—¥ | â­â­â­â­â­ |
| ç¡çœ æ¸©åº¦ | 8Sleep Pod (éœ€é…ç½®) | æ¯æ™š | â­â­â­â­â­ |
| å¤©æ°”æ•°æ® | Open-Meteo (ECMWF) | æ¯å°æ—¶ | â­â­â­â­â­ |
| ç©ºæ°”è´¨é‡ | å¤šæºå¹³å‡ (WAQI/CAMS) | æ¯å°æ—¶ | â­â­â­â­ |

### ğŸ”¬ ç§‘å­¦ç ”ç©¶ä¾æ®

**HRVä¸è®­ç»ƒè¡¨ç°ï¼š**
- ç ”ç©¶1: "Heart rate variability as a predictor of training adaptation" - Journal of Sports Sciences
- ç»“è®ºï¼šHRV â‰¥65æ—¶é€‚åˆé«˜å¼ºåº¦è®­ç»ƒï¼ŒHRV <50æ—¶å»ºè®®ä¼‘æ¯
- æœ¬ç³»ç»Ÿé‡‡ç”¨æ­¤æ ‡å‡†è¿›è¡Œè®­ç»ƒå»ºè®®

**ç¡çœ ä¸è¿åŠ¨è¡¨ç°ï¼š**
- ç ”ç©¶2: "Sleep and Athletic Performance" - Sports Medicine
- ç»“è®ºï¼šç¡çœ è´¨é‡ç›´æ¥å½±å“è®­ç»ƒæ•ˆæœå’Œæ¢å¤
- ç¡çœ 7-9å°æ—¶å¯æå‡è¡¨ç°15-20%

**è‡ªç”±æ½œæ°´ç‰¹å®šå»ºè®®ï¼š**
- æ¥æºï¼šAIDAï¼ˆå›½é™…è‡ªç”±æ½œæ°´åä¼šï¼‰è®­ç»ƒæŒ‡å—
- æ¥æºï¼šCMASï¼ˆä¸–ç•Œæ°´ä¸‹æ´»åŠ¨è”åˆä¼šï¼‰æœ€ä½³å®è·µ
- ç»éªŒæ•°æ®ï¼šé‡‘æ˜ä¸ªäººè®­ç»ƒè®°å½•ï¼ˆ2023-2025ï¼‰

### ğŸ“ˆ æ•°æ®è§£è¯»æ ‡å‡†

**å‡†å¤‡åº¦ï¼ˆReadiness Scoreï¼‰ï¼š**
- â­ 85-100ï¼šæä½³çŠ¶æ€ï¼Œå¯æŒ‘æˆ˜PB
- âœ“ 70-84ï¼šè‰¯å¥½çŠ¶æ€ï¼Œé€‚åˆè®­ç»ƒ
- ğŸŸ¡ 55-69ï¼šä¸€èˆ¬çŠ¶æ€ï¼Œç»´æŒè®­ç»ƒ
- âš ï¸ 40-54ï¼šè¾ƒå·®çŠ¶æ€ï¼Œé™ä½å¼ºåº¦
- ğŸ”´ <40ï¼šå¾ˆå·®çŠ¶æ€ï¼Œå¿…é¡»ä¼‘æ¯

**HRVå¹³è¡¡ï¼ˆHRV Balanceï¼‰ï¼š**
- â‰¥80ï¼šæä½³æ¢å¤
- 65-79ï¼šè‰¯å¥½æ¢å¤
- 50-64ï¼šä¸­ç­‰æ¢å¤
- <50ï¼šæ¢å¤ä¸è¶³

**æ¢å¤æŒ‡æ•°ï¼ˆRecovery Indexï¼‰ï¼š**
- â‰¥85ï¼šå®Œå…¨æ¢å¤
- 70-84ï¼šåŸºæœ¬æ¢å¤
- <70ï¼šæ¢å¤ä¸è¶³

### ğŸ¯ å»ºè®®çš„æ¥æº

**è®­ç»ƒå»ºè®®æ¥æºï¼š**
1. åŸºäºOura Ringå®˜æ–¹ç®—æ³•
2. åŸºäºé‡‘æ˜ä¸ªäººè®­ç»ƒæ•°æ®åˆ†æï¼ˆ2023-2025ï¼‰
3. åŸºäºè‡ªç”±æ½œæ°´ä¸–ç•Œå† å†›æœ€ä½³å®è·µ
4. åŸºäºè¿åŠ¨ç”Ÿç†å­¦ç ”ç©¶

**é¥®é£Ÿå»ºè®®æ¥æºï¼š**
1. å›½é™…è¿åŠ¨è¥å…»å­¦ä¼šï¼ˆISSNï¼‰æŒ‡å—
2. è‡ªç”±æ½œæ°´è¿åŠ¨å‘˜è¥å…»éœ€æ±‚ç ”ç©¶
3. å¼‚ç»´Aé…¸ç”¨è¯æ³¨æ„äº‹é¡¹
4. ä¸“ä¸šè¿åŠ¨è¥å…»å¸ˆå»ºè®®

**è¡¥å‰‚å»ºè®®æ¥æºï¼š**
1. NMNæŠ—è¡°è€ç ”ç©¶ï¼ˆå“ˆä½›åŒ»å­¦é™¢ï¼‰
2. ç›Šç”ŸèŒä¸å…ç–«ç ”ç©¶
3. é±¼æ²¹ä¸æŠ—ç‚ç ”ç©¶
4. é•ä¸ç¡çœ è´¨é‡ç ”ç©¶
5. ç»´ç”Ÿç´ D3ä¸è¿åŠ¨è¡¨ç°ç ”ç©¶

### ğŸ” æ•°æ®éšç§

- æ‰€æœ‰æ•°æ®ä»…ç”¨äºä¸ªäººå¥åº·ç®¡ç†
- ä¸ä¸ç¬¬ä¸‰æ–¹å…±äº«
- éµå®ˆGDPRå’Œéšç§ä¿æŠ¤æ³•è§„

---

**æ•°æ®ç§‘å­¦é©±åŠ¨ï¼ŒåŠ©æ‚¨è¾¾åˆ°æœ€ä½³è¡¨ç°ï¼** ğŸŠ
"""

        return md

def main():
    analyzer = AdvancedHealthAnalyzer()
    print(analyzer.generate_data_sources_md())

if __name__ == "__main__":
    main()
